<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=big5">
    <title>3D ID power density distribution calculator</title>
    <script language="javascript">AC_FL_RunContent = 0;</script>
    <script src="js/AC_RunActiveContent.js"></script>
    <script src="js/hashtable.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript" src="js/graph3d.js"></script>
  </head>
  <body class="oneColFixCtr">
    <div id="container">
      <div id="mainContent">
        <table align="center" cellspacing="0" cellpadding="0" bordercolor="#000000"
          border="0" bgcolor="#FFFFFF">
          <tbody>
            <tr>
              <td colspan="5">
               </script><br>
              </td>
            </tr>
            <tr>
              <td colspan="5" align="center">
                <div id="dreamweaver_design_view_show" style="display:none;width:547px;height:21px;">Infinite
                  Menus Place Holder (Dreamweaver Design View)</div>
                <div id="dreamweaver_design_view_hide"> </div>
              </td>
            </tr>
            <tr>
              <td colspan="5" align="center" valign="middle"> <b>NSRRC TPS insertion
                  device power density distribution profile </b>
                <dl style="text-align: right;">
                  08/30/2024 Version 2.1 <br>
                  by Albert Sheng (shengic@nsrrc.org.tw)
                </dl>
              </td>
            </tr>
            <tr>
              <td colspan="5" align="center" valign="middle" bgcolor="#FFFFFF">
                <table style="width: 726px; height: 424px;" border="1">
                  <tbody>
                    <tr>
                      <td border="1" width="200" valign="top">
                        <form id="thisForm">
                          <script>
id05A = new HashTable({name: 'IU22', periodLength: 2.2, Nperiod: 140, totalLength: 3.08, kx: 0,ky: 1.561648})
id41A = new HashTable({name: 'EPU48', periodLength: 4.8, Nperiod: 65, totalLength: 3.12, kx: 2.46576,ky: 3.721056})
id45A = new HashTable({name: 'EPU46', periodLength: 4.6, Nperiod: 79, totalLength: 3.634, kx: 2.019308,ky: 3.136372})
id25A = new HashTable({name: 'IU22', periodLength: 2.2, Nperiod: 140, totalLength: 3.08, kx: 0,ky: 1.561648})
id21A = new HashTable({name: 'IUT22', periodLength: 2.2, Nperiod: 140, totalLength: 3.08, kx: 0,ky: 1.684936})
id23A = new HashTable({name: 'IU22', periodLength: 2.2, Nperiod: 156, totalLength: 3.432, kx: 0,ky: 1.561648})
id09A = new HashTable({name: 'IU22', periodLength: 2.2, Nperiod: 140, totalLength: 3.08, kx: 0,ky: 1.561648})

id13A = new HashTable({name: 'IU24', periodLength: 2.4, Nperiod: 166, totalLength: 3.984, kx: 0,ky: 2.039856})
id15A = new HashTable({name: 'CUT18', periodLength: 1.8, Nperiod: 111, totalLength: 1.998, kx: 0,ky: 1.983816})
id19A = new HashTable({name: 'CU15', periodLength: 1.5, Nperiod: 133, totalLength: 1.995, kx: 0,ky: 1.42902})
id27A = new HashTable({name: 'EPU66', periodLength: 6.6, Nperiod: 61, totalLength: 4.026, kx: 3.945216,ky: 5.363028})
id31A = new HashTable({name: 'W100', periodLength: 10, Nperiod: 4, totalLength: 0.4, kx: 0,ky: 16.9054})
id39A = new HashTable({name: 'EPU168', periodLength: 16.8, Nperiod: 22, totalLength: 3.696, kx: 3.608976,ky: 8.002512})
id07A = new HashTable({name: 'IU22', periodLength: 2.2, Nperiod: 140, totalLength: 3.08, kx: 0,ky: 1.684936})

id35A = new HashTable({name: 'EPU66', periodLength: 6.6, Nperiod: 7, totalLength: 0.462, kx: 3.883572,ky: 5.363028})
id43A = new HashTable({name: 'EPU56', periodLength: 5.6, Nperiod: 72, totalLength: 4.032, kx: 3.033632,ky: 4.498144})
id11A = new HashTable({name: 'CUT18', periodLength: 1.8, Nperiod: 111, totalLength: 1.998, kx: 0,ky: 1.34496})
id47A = new HashTable({name: 'IU24', periodLength: 2.4, Nperiod: 125, totalLength: 3, kx: 0,ky: 1.79328})

//alert('value of total length :' + id1201.getItem('totalLength'));
</script> <p id="idName"></p>
                         <input name="thisRadio" value="05A" onclick="selectID(this, id05A)" type="radio">05A IU22 (Phase 1)<br>
<input name="thisRadio" value="41A" onclick="selectID(this, id41A)" type="radio">41A EPU48 (Phase 1)<br>
<input name="thisRadio" value="45A" onclick="selectID(this, id45A)" type="radio">45A EPU46 (Phase 1)<br>
<input name="thisRadio" value="25A" onclick="selectID(this, id25A)" type="radio">25A IU22 (Phase 1)<br>
<input name="thisRadio" value="21A" onclick="selectID(this, id21A)" type="radio">21A IUT22 (Phase 1)<br>
<input name="thisRadio" value="23A" onclick="selectID(this, id23A)" type="radio">23A IU22 (Phase 1)<br>
<input name="thisRadio" value="09A" onclick="selectID(this, id09A)" type="radio">09A IU22 (Phase 1)<br>

<input name="thisRadio" value="13A" onclick="selectID(this, id13A)" type="radio">13A IU24 (Phase 2)<br>
<input name="thisRadio" value="15A" onclick="selectID(this, id15A)" type="radio">15A CUT18 (Phase 2)<br>
<input name="thisRadio" value="19A" onclick="selectID(this, id19A)" type="radio">19A CU15 (Phase 2)<br>
<input name="thisRadio" value="27A" onclick="selectID(this, id27A)" type="radio">27A EPU66 (Phase 2)<br>
<input name="thisRadio" value="31A" onclick="selectID(this, id31A)" type="radio">31A W100 (Phase 2)<br>
<input name="thisRadio" value="39A" onclick="selectID(this, id39A)" type="radio">39A EPU168 (Phase 2)<br>
<input name="thisRadio" value="07A" onclick="selectID(this, id07A)" type="radio">07A IU22 (Phase 2)<br>

<input name="thisRadio" value="35A" onclick="selectID(this, id35A)" type="radio">35A EPU66 (Phase 3)<br>
<input name="thisRadio" value="43A" onclick="selectID(this, id43A)" type="radio">43A EPU56 (Phase 3)<br>
<input name="thisRadio" value="11A" onclick="selectID(this, id11A)" type="radio">11A CUT18 (Phase 3)<br>
<input name="thisRadio" value="47A" onclick="selectID(this, id47A)" type="radio">47A IU24 (Phase 3)<br>
                        </form>
                        <script>

function selectID(radio,idHash) {
  if(radio.checked){
   document.getElementById("idName").innerHTML = idHash.getItem("name"); 
   powerForm = document.getElementById("powerForm");
  // powerForm.elements["energy"].value = 3;
   //powerForm.elements["current"].value = 800;
   powerForm.elements["periodLength"].value = idHash.getItem("periodLength");
   powerForm.elements["N"].value = idHash.getItem("Nperiod");
   powerForm.elements["Length"].value = idHash.getItem("totalLength");
   powerForm.elements["kx"].value = idHash.getItem("kx");
   powerForm.elements["ky"].value = idHash.getItem("ky");
//   powerForm.elements["powerDensity"].value = 1.;
//   powerForm.elements["totalPower"].value = 1.;

  } else {
    document.getElementById("idName").innerHTML = "EPU66";
	var idHash = id801;
   powerForm = document.getElementById("powerForm");
   powerForm.elements["energy"].value = 3;
   powerForm.elements["current"].value = 800;
   powerForm.elements["periodLength"].value = idHash.getItem("periodLength");
   powerForm.elements["N"].value = idHash.getItem("Nperiod");
   powerForm.elements["Length"].value = idHash.getItem("totalLength");
   powerForm.elements["kx"].value = idHash.getItem("kx");
   powerForm.elements["ky"].value = idHash.getItem("ky");
//   powerForm.elements["powerDensity"].value = 1.;
//   powerForm.elements["totalPower"].value = 1.;

  }
// determine xmax, xmin, ymax, ymin range
   gamma = 1957. * powerForm.elements["energy"].value /1000. ;
   var plotRatio = 1.5;
   xmax = (powerForm.elements["ky"].value + 1. )/gamma * plotRatio;
   ymax = (powerForm.elements["kx"].value+1)/gamma * plotRatio;
   powerForm.elements["xmax"].value = xmax.toFixed(3);
   powerForm.elements["xmin"].value = - powerForm.elements["xmax"].value;
   powerForm.elements["ymax"].value = ymax.toFixed(3);
   powerForm.elements["ymin"].value = - powerForm.elements["ymax"].value;

   drawVisualization();

}   
</script> </td>
                      <td align="center">
                        <form id="powerForm">
                          <table style="width: 400px; height: 311px;" border="1">
                            <tbody>
                              <tr>
                                <td class="shadow2" width="130">Energy </td>
                                <td class="shadow2" width="130"><label> <input

                                      name="energy" size="10" id="energy" value="3"

                                      type="text"> GeV</label></td>
                              </tr>
                              <tr>
                                <td class="shadow2">Beam current </td>
                                <td class="shadow2"><input name="current" size="10"

                                    id="current" value="800" type="text"> mA</td>
                              </tr>
                              <tr>
                                <td class="shadow2">Period length</td>
                                <td class="shadow2"><input name="periodLength" size="10"

                                    id="periodLength" value="1.9" type="text">
                                  cm</td>
                              </tr>
                              <tr>
                                <td class="shadow2">Number of period</td>
                                <td class="shadow2"><input name="N" size="10" id="N"

                                    value="209" type="text"></td>
                              </tr>
                              <tr>
                                <td class="shadow2">Total length</td>
                                <td class="shadow2"><input name="Length" size="10"

                                    id="Length" value="3.97" type="text"></td>
                              </tr>
                              <tr>
                                <td class="shadow2">Kx</td>
                                <td class="shadow2"><input name="kx" size="10" id="kx"

                                    value="0" type="text"></td>
                              </tr>
                              <tr>
                                <td class="shadow2">Ky</td>
                                <td class="shadow2"><input name="ky" size="10" id="ky"

                                    value="2.18276" type="text"></td>
                              </tr>
                              <tr>
                                <td class="shadow2">Theoretical power density along x axis</td>
                                <td class="shadow2"><input size="10" name="theoretical_powerDensity_x"
                                    id="theoretical_powerDensity_x" type="text"> kW/mrad^2</td>
                              </tr>
                              <tr>
                              <tr>
                                <td class="shadow2">Theoretical power density along y axis</td>
                                <td class="shadow2"><input size="10" name="theoretical_powerDensity_y"
                                    id="theoretical_powerDensity_y" type="text"> kW/mrad^2</td>
                              </tr>
                              <tr>
                                <td class="shadow2">Theoretical total power</td>
                                <td class="shadow2"><input size="10" name="theoretical_totalPower"
                                    id="theoretical_totalPower" type="text"> kW</td>
                              </tr>
                              <tr>
                                <td class="shadow2">X min <input name="xmin" id="xmin"

                                    value="-1" size="10" type="text"> mrad</td>
                                <td class="shadow2">X max <input name="xmax" id="xmax"

                                    value="1" size="10" type="text"> mrad</td>
                              </tr>
                              <tr>
                                <td class="shadow2">Y min <input name="ymin" id="ymin"

                                    value="-1" size="10" type="text"> mrad</td>
                                <td class="shadow2">Y max <input name="ymax" id="ymax"

                                    value="1" size="10" type="text"> mrad</td>
                              </tr>
							                                <tr>
                                <td class="shadow2">Maximum power density of the regioned area</td>
                                <td class="shadow2"><input size="10" name="powerDensity"
                                    id="powerDensity" type="text"> kW/mrad^2</td>
                              </tr>
                              <tr>
                                <td class="shadow2">Total power of the regioned area</td>
                                <td class="shadow2"><input size="10" name="totalPower"
                                    id="totalPower" type="text"> kW</td>
                              </tr>
                            </tbody>
                          </table>
                          <p> <input name="calculate" onclick="drawVisualization()" value="recalculate" type="button"> </p>
						  <input name="openWindow" onclick="openDataWindow()" value="Get 3D data" type="button"> </p>
                        </form>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <script type="text/javascript">
 function draw3d(){
      google.setOnLoadCallback(drawVisualization);
  // Instantiate our graph object.
        graph = new links.Graph3d(document.getElementById('mygraph'));

  // Draw our graph with the created data and options
        graph.draw(data, options);
 }

</script> <script type="text/javascript">
        var data = null;
        var graph = null;
		var htmlData;
		
		htmlData = "<html><head></head><body>";
		
        google.load("visualization", "1");

        // Set callback to run when API is loaded
        google.setOnLoadCallback(drawVisualization);

        function custom(x, y) {
            return (Math.sin(x/50) * Math.cos(y/50) * 50 + 50);
        }

        // Called when the Visualization API is loaded.
        function drawVisualization() {
            // Create and populate a data table.
            data = new google.visualization.DataTable();
            data.addColumn('number', 'x (mrad)');
            data.addColumn('number', 'y (mrad)');
            data.addColumn('number', 'W/mrad^2');

//            // create some nice looking data with sin/cos
//            var steps = 50;  // number of datapoints will be steps*steps
//            var axisMax = 314;
//            var axisStep = axisMax / steps;
//            for (var x = 0; x < axisMax; x+=axisStep) {
//                for (var y = 0; y < axisMax; y+=axisStep) {
//                    var value = custom(x,y);
//                    data.addRow([x, y, value]);
//                }
//            }

// 20150813 rewrite for EPU power by Albert Sheng
        var theform = document.getElementById('powerForm');
        gamma = 1957. * parseFloat(theform.energy.value) /1000. ;
        kx = parseFloat(theform.kx.value);
        ky = parseFloat(theform.ky.value);
 //       var powerDensity =  0.0844 * Math.pow(theform.energy.value, 4) * parseFloat(theform.current.value)/1000. * theform.Length.value /  Math.pow(theform.periodLength.value/100., 2);
       var powerDensity =  13.44 * Math.pow(10,-4) * Math.pow(theform.energy.value,4)* theform.current.value/1000. * 2.*Math.PI * theform.N.value/theform.periodLength.value;
       var theoretical_totalPower = 0.633 * Math.pow(theform.energy.value,2) * (Math.pow(theform.kx.value,2) + Math.pow(theform.ky.value,2)) / Math.pow(0.934 * theform.periodLength.value,2) * theform.Length.value * theform.current.value / 1000.;
	   
	   var totalPower = 0.;
	   var maxPowerDensity =0.;
	   var theoretical_powerDensity_x = 0.;
	   var theoretical_powerDensity_y = 0.;
	   
	   theoretical_powerDensity_x = 0.058*Math.pow(10,4)*Math.pow(theform.energy.value,4)*theform.current.value/1000/Math.pow(theform.periodLength.value,2)*theform.Length.value*theform.kx.value/1000*powerDensityRatio(theform.kx.value,theform.ky.value);
	   
	   theoretical_powerDensity_y = 0.058*Math.pow(10,4)*Math.pow(theform.energy.value,4)*theform.current.value/1000/Math.pow(theform.periodLength.value,2)*theform.Length.value*theform.ky.value/1000*powerDensityRatio(theform.kx.value, theform.ky.value);
	       
	    if(theoretical_powerDensity_x == 0.){
		  theoretical_powerDensity_x = theoretical_powerDensity_y;
		}
		
		if(theoretical_powerDensity_y == 0.){
		  theoretical_powerDensity_y = theoretical_powerDensity_x;
		}
		   
		var steps = 100;
		var steps = 100;
		var maxPowerDensity = 0.;
		var xstep = (parseFloat(theform.xmax.value) - parseFloat(theform.xmin.value))/(steps);
		var ystep = (parseFloat(theform.ymax.value) - parseFloat(theform.ymin.value))/(steps);
		var gridArea = xstep*ystep;
		var xmin = parseFloat(theform.xmin.value);
		var ymin = parseFloat(theform.ymin.value);
		var xmax = parseFloat(theform.xmax.value);
		var ymax = parseFloat(theform.ymax.value);
		var nbsp = "&nbsp".repeat(10);
		htmlData += "<table>\n";
		htmlData += "<tr><td>theta_x (mrad),</td><td>theta_y (mrad), </td><td>power_density (kW/mrad^2)</td><tr>";
		for(thetax = xmin; thetax < xmax + xstep; thetax += xstep){
		 for(thetay = ymin; thetay < ymax + ystep; thetay += ystep){
	//	        var value = custom(thetax,thetay);
	 		   var value =  powerDensity * getIntegratedShapeFunction(-Math.PI, Math.PI);
			   data.addRow([thetax, thetay, value]);
			   htmlData += "<tr><td>" + thetax.toExponential(6) + ",</td><td>" + thetay.toExponential(6) + ",</td><td>" + value.toExponential(6) + "</td></tr>\n";
			   totalPower += value;
			   maxPowerDensity = value >= maxPowerDensity ? value : maxPowerDensity; 
	//		   document.write("[thetax, thetay, value] =" + "[" + thetax + "," + thetay + "," + value + "] <br>");
		 }

	 }
//		 alert("max power density = " + maxPowerDensity);
        htmlData += "</table></body></html>";
        theform.powerDensity.value = maxPowerDensity.toFixed(3);
// multiple area to get total power for current region		 
		 totalPower *= gridArea;
		 theform.totalPower.value = totalPower.toFixed(3);
// theoretical power density and total power
         
		 theform.theoretical_powerDensity_x.value = theoretical_powerDensity_x.toFixed(3);
		 theform.theoretical_powerDensity_y.value = theoretical_powerDensity_y.toFixed(3);
		 theform.theoretical_totalPower.value = theoretical_totalPower.toFixed(3);		 

            // specify options
            var options = {
                width:  "600px",
                height: "400px",
                style: "surface",
                showPerspective: true,
                showGrid: true,
                showShadow: false,
                keepAspectRatio: true,
                verticalRatio: 0.5
            };

            // Instantiate our graph object.
             graph = new links.Graph3d(document.getElementById('mygraph'));

            // Draw our graph with the created data and options
             graph.draw(data, options);
        }

function powerDensityRatio(kx,ky){
 var powerDensityRatio = 2;
 if(kx >0 && ky>0) {
   powerDensityRatio = 1;
 }
 return powerDensityRatio;
}

function openDataWindow(){
  var dataWindow = window.open("", "3D data", "width=500, height=800,scrollbars=1,resizable=1");
  dataWindow.document.open();
  dataWindow.document.write(htmlData);
  dataWindow.document.close();
}

var gamma;
var kx;
var ky
var thetax;
var thetay ;

 function getIntegratedShapeFunction(a, b){
   var n = 300;
   var shape = shapeFunction(a)/2.
   var step = (b-a)/ n ;
   for(i=1; i <= n -1; i++ )
   {
     var x = a + step*i;
	 shape += shapeFunction(x);
   }
	 shape += shapeFunction(b)/2.;
// https://en.wikipedia.org/wiki/Numerical_integration
	 shape = (b-a)/n * shape;
	 return shape;
}


  function shapeFunction2(x){
    var shapeFunction = 100.*x;
	return shapeFunction;
 }

  function shapeFunction(x){
      var D = 1. + Math.pow(ky * Math.sin(x) - gamma * thetax, 2) + Math.pow(kx * Math.cos(x) - gamma * thetay, 2);
	  var shapeFunction = (Math.pow(ky * Math.cos(x),2) + Math.pow(kx * Math.sin(x),2))/Math.pow(D,3) -
	  Math.pow(((Math.pow(ky,2) - Math.pow(kx,2))*Math.sin(2.*x) -
	  2.*ky*gamma*thetax*Math.cos(x) + 
	  2.*kx*gamma*thetay*Math.sin(x)),2)/ Math.pow(D, 5);
//	  document.write("(x,shapefunction)=" + x + "," + shapeFunction + "<br>" );
	  return shapeFunction;

  }	

	</script>
                <div id="mygraph"></div>
                <br>
                <div id="info"><a href="https://als.lbl.gov/disclaimer/">Disclaimer</a></div>
              </td>
            </tr>

          </tbody>
        </table>
        <!-- end #mainContent --></div>
      <!-- end #container --></div>
  </body>
  <!-- InstanceEnd -->
</html>